<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basecamp Coffee - Ramadhan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827;
            /* Background Pattern Halus */
            background-image: 
                radial-gradient(at 0% 0%, rgba(22, 101, 52, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(180, 83, 9, 0.2) 0px, transparent 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .font-arab { font-family: 'Amiri', serif; }

        @keyframes neon-blink {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px #fbbf24, 0 0 10px #d97706; transform: scale(1); }
            50% { opacity: 0.7; text-shadow: none; transform: scale(0.98); }
        }
        .blinking-text { animation: neon-blink 2s infinite ease-in-out; }

        .app-card {
            width: 100%;
            max-width: 380px;
            background-color: #1f2937;
            border: 1px solid #166534;
            border-radius: 24px;
            box-shadow: 0 0 50px rgba(22, 163, 74, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
        }

        .header-section {
            background: linear-gradient(160deg, #022c22 0%, #064e3b 100%);
            position: relative;
            padding: 15px 20px 20px 20px; 
            text-align: center;
            border-bottom: 2px solid #ca8a04;
            overflow: hidden;
        }

        .header-ornament {
            position: absolute;
            top: -20px; left: -20px;
            width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .content-area {
            padding: 15px 20px;
            padding-bottom: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .content-area::-webkit-scrollbar { width: 0; }

        .input-dark {
            background-color: #111827;
            border: 1px solid #374151;
            color: white;
            transition: all 0.3s;
        }
        .input-dark:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            outline: none;
        }

        .btn-green-glow {
            background: linear-gradient(to right, #16a34a, #15803d);
            border: 1px solid #22c55e;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
            transition: transform 0.2s;
        }
        .btn-green-glow:active { transform: scale(0.98); }

        .hour-btn {
            background: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
        }
        .hour-btn.active {
            background: #22c55e;
            color: black;
            font-weight: bold;
            border-color: #86efac;
            box-shadow: 0 0 10px #22c55e;
        }

        .radio-box {
            background: #111827;
            border: 1px solid #374151;
            transition: all 0.2s;
        }
        input:checked + .radio-box {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }
        input:checked + .radio-box i,
        input:checked + .radio-box div {
            color: #4ade80 !important;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CHAT SYSTEM CSS (Posisi Kiri Bawah) */
        .chat-bubble-user {
            background-color: #166534;
            color: white;
            border-radius: 12px 12px 0 12px;
            padding: 8px 12px;
            font-size: 11px;
            max-width: 80%;
            align-self: flex-end;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            word-wrap: break-word;
        }
        .chat-bubble-admin {
            background-color: #374151;
            color: white;
            border-radius: 12px 12px 12px 0;
            padding: 8px 12px;
            font-size: 11px;
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-left: 2px solid #ca8a04;
            word-wrap: break-word;
        }
        .typing-indicator span {
            display: inline-block;
            width: 5px;
            height: 5px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        #chatMessages::-webkit-scrollbar { width: 4px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        /* Tombol WA Custom Color */
        .bg-whatsapp { background-color: #25D366; }
        .hover-bg-whatsapp:hover { background-color: #1ebe57; }
    </style>
</head>
<body>

    <!-- Tombol Admin Settings -->
    <button onclick="openAdminLogin()" class="fixed top-4 right-4 z-40 text-gray-500 hover:text-green-400 transition bg-black/30 p-2 rounded-full backdrop-blur-sm border border-gray-700">
        <i class="fa-solid fa-gear text-lg"></i>
    </button>

    <div class="app-card">
        
        <!-- HEADER -->
        <div class="header-section">
            <div class="header-ornament"></div>
            <div class="mb-1 text-yellow-400 opacity-90 animate-pulse">
                <i class="fa-solid fa-moon text-lg"></i>
            </div>
            <h1 class="text-2xl text-yellow-400 font-arab font-bold mb-1 -mt-1 blinking-text leading-none relative z-10">
                ÿ±ŸÖÿ∂ÿßŸÜ ŸÖÿ®ÿßÿ±ŸÉ
            </h1>
            <div class="relative z-10 bg-black/20 backdrop-blur-sm border border-white/10 rounded-lg p-1.5 mx-10">
                <h2 class="text-[10px] font-bold text-green-300 font-sans tracking-wide uppercase drop-shadow-md mb-0.5">
                    Basecamp Coffee
                </h2>
                <p class="text-[6px] text-gray-300 font-light italic leading-tight">
                    Mengucapkan Selamat Menunaikan<br>Ibadah Puasa 1447 H
                </p>
            </div>
        </div>

        <div class="content-area space-y-4">
            
            <!-- Nama -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Nama Pelanggan</label>
                <div class="relative mt-1">
                    <span class="absolute left-3 top-2.5 text-green-600"><i class="fa-solid fa-user"></i></span>
                    <input type="text" id="renterName" class="w-full input-dark rounded-xl py-2.5 pl-9 pr-4 text-sm" placeholder="Masukkan nama...">
                </div>
            </div>

            <!-- Durasi -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Pilih Durasi (Jam)</label>
                <div class="grid grid-cols-6 gap-2 mt-1" id="hourGrid"></div>
            </div>

            <!-- Voucher -->
            <div id="promoSection" class="hidden fade-in bg-green-900/20 p-3 rounded-xl border border-green-600/30 border-dashed">
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase mb-1 block"><i class="fa-solid fa-ticket mr-1"></i> Kode Voucher</label>
                <input type="text" id="voucherCode" placeholder="Masukkan Kode Promo" oninput="updateSummary()" 
                    class="w-full bg-black/40 border border-green-600/30 rounded-lg py-2 text-center text-sm font-bold text-yellow-400 uppercase tracking-widest focus:outline-none focus:border-green-500 placeholder-gray-600">
                <p id="voucherMessage" class="text-center text-[9px] mt-1 h-3 font-bold"></p>
            </div>

            <!-- Metode Pembayaran -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Metode Pembayaran</label>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="Kotak (Atas TV)" class="peer sr-only" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-box-open text-yellow-500 text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Kotak<br>(Atas TV)</div>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="Kasir" class="peer sr-only" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-cash-register text-blue-400 text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Bayar<br>di Kasir</div>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="QRIS" class="peer sr-only" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-qrcode text-white text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Scan<br>QRIS</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Tampilan QRIS -->
            <div id="qrisDisplay" class="hidden fade-in bg-white p-4 rounded-xl text-center shadow-lg mt-2">
                <p class="text-black font-bold text-xs mb-2">Scan QRIS</p>
                <img src="QRIS.jpg" onerror="this.src='https://via.placeholder.com/150?text=QRIS+ERROR'" class="mx-auto w-32 h-32 object-contain border border-black rounded">
            </div>

            <!-- Total -->
            <div class="bg-black/60 backdrop-blur-md rounded-xl p-4 border-l-4 border-green-500 flex justify-between items-center mt-2">
                <div>
                    <p class="text-[9px] text-gray-400 uppercase tracking-wide">Total Pembayaran</p>
                    <p class="text-white font-bold text-xl drop-shadow-sm" id="totalPrice">Rp 0</p>
                </div>
                <div class="text-right">
                    <span class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded font-bold uppercase" id="durationDisplay">0 Jam</span>
                </div>
            </div>

            <!-- Tombol Submit -->
            <button onclick="processPayment()" id="payBtn"
                class="w-full btn-green-glow py-4 rounded-xl text-white font-bold text-sm tracking-wider flex justify-center items-center gap-2 mt-2">
                <i class="fa-solid fa-play"></i> MULAI BERMAIN
            </button>

            <!-- Footer -->
            <div class="text-center text-[8px] text-gray-600 pt-2 pb-4">
                &copy; 2026 Basecamp Coffee System (AI Powered)
            </div>

        </div>
    </div>

    <!-- TMBOL CHAT MENGAMBANG (DIPINDAH KE KIRI BAWAH & LOGO WHATSAPP) -->
    <button onclick="toggleChat()" class="fixed bottom-6 left-6 bg-whatsapp hover-bg-whatsapp text-white w-14 h-14 rounded-full shadow-[0_0_15px_rgba(37,211,102,0.5)] z-40 flex items-center justify-center transition transform active:scale-95">
        <i class="fa-brands fa-whatsapp text-3xl"></i>
    </button>

    <!-- KOTAK CHAT IN-APP (TETAP DI KIRI BAWAH) -->
    <div id="chatWidget" class="hidden fixed bottom-24 left-6 w-72 sm:w-80 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl z-50 flex flex-col overflow-hidden fade-in">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-green-700 to-green-900 p-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-black/30 rounded-full flex items-center justify-center border border-green-400">
                    <i class="fa-brands fa-whatsapp text-green-200 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-white text-xs font-bold leading-tight">Live Chat Basecamp</h3>
                    <p id="chatStatus" class="text-[9px] text-green-200 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> Online
                    </p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white/70 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        
        <!-- Chat Body -->
        <div id="chatMessages" class="p-3 h-64 bg-[#111827] flex flex-col gap-3 overflow-y-auto">
            <div class="text-center text-[9px] text-gray-500 my-2">Gemini AI & Live Support</div>
            <!-- Initial Auto Message -->
            <div class="chat-bubble-admin fade-in">
                Halo lur! üëã Nyong asisten AI Basecamp Coffee. Ana sing bisa tek bantu soal rental PS kiye?
            </div>
        </div>
        
        <!-- Chat Footer -->
        <div class="p-2 bg-gray-800 border-t border-gray-700 flex gap-2 items-center">
            <input type="text" id="chatInput" onkeypress="handleChatEnter(event)" placeholder="Ketik pesene sampeyan..." class="flex-1 bg-gray-900 text-white text-xs rounded-xl py-2 px-3 border border-gray-600 focus:border-green-500 focus:outline-none">
            <button onclick="sendChatMessage()" class="bg-whatsapp hover-bg-whatsapp text-white p-2 rounded-xl transition">
                <i class="fa-solid fa-paper-plane text-xs"></i>
            </button>
        </div>
    </div>

    <!-- MODAL SUCCESS -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-6">
        <div class="bg-slate-900 rounded-2xl p-8 max-w-xs w-full text-center border border-green-500 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-emerald-500"></div>
            <div class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500 animate-pulse">
                <i class="fa-solid fa-check text-3xl text-green-400"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">BERHASIL!</h2>
            <p class="text-gray-400 text-xs mb-6">Orderan terkirim. Selamat bermain!</p>
            <button onclick="closeModal()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition">TUTUP</button>
        </div>
    </div>

    <!-- MODAL ADMIN LOGIN & SETTINGS -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-50 backdrop-blur-md">
        <div class="bg-slate-900 p-6 rounded-2xl border border-slate-700 w-72 shadow-2xl">
            <h3 class="text-green-400 text-center mb-4 text-xs font-bold tracking-widest uppercase">Admin Access</h3>
            <input type="password" id="adminPassword" class="w-full p-3 rounded-lg bg-black border border-slate-600 text-white text-sm mb-4 text-center focus:border-green-500 outline-none" placeholder="Masukkan Password">
            <div class="flex gap-2">
                <button onclick="document.getElementById('adminLoginModal').classList.add('hidden')" class="w-1/2 bg-slate-800 text-gray-400 p-2 rounded-lg text-xs font-bold">BATAL</button>
                <button onclick="checkAdmin()" class="w-1/2 bg-green-600 text-white p-2 rounded-lg text-xs font-bold">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="adminSettingsModal" class="hidden fixed inset-0 bg-black/95 flex items-center justify-center z-50 p-6 backdrop-blur-md">
        <div class="bg-slate-900 p-6 rounded-2xl border border-green-600 w-80 shadow-2xl">
            <h3 class="text-green-400 text-center mb-5 text-sm font-bold border-b border-slate-700 pb-3">PENGATURAN SISTEM</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] text-gray-400 font-bold">KODE VOUCHER (3 JAM)</label><input id="setCode" class="w-full p-2 bg-black border border-slate-600 rounded text-green-400 text-sm font-bold text-center uppercase focus:border-green-500 outline-none"></div>
                <div><label class="text-[10px] text-gray-400 font-bold">HARGA PAKET PROMO (RP)</label><input id="setPromo" type="number" class="w-full p-2 bg-black border border-slate-600 rounded text-white text-sm focus:border-green-500 outline-none"></div>
                <div><label class="text-[10px] text-gray-400 font-bold">HARGA NORMAL / JAM (RP)</label><input id="setNormal" type="number" class="w-full p-2 bg-black border border-slate-600 rounded text-white text-sm focus:border-green-500 outline-none"></div>
            </div>
            <button onclick="saveSettings()" class="w-full mt-6 bg-green-600 text-white font-bold p-3 rounded-xl text-xs shadow-lg hover:bg-green-500">SIMPAN PERUBAHAN</button>
        </div>
    </div>

    <script>
        // API KEY GEMINI (Disediakan oleh environment)
        const apiKey = ""; 

        // === CONFIGURASI UTAMA ===
        const DEFAULT_CONFIG = { voucherCode: "HARI INI", voucherPrice: 10000, hourlyPrice: 5000 };
        let config = JSON.parse(localStorage.getItem('ps_config')) || DEFAULT_CONFIG;
        
        // BOT UNTUK NOTIFIKASI ORDER & LOG CHAT
        const CHAT_BOT_TOKEN = "8514459117:AAH3kJ4MLDwnhykBMTSCLKatglFudZfm_dM"; 
        const ADMIN_CHAT_ID = "7933777456"; 
        const ALL_BOTS = ["8339576140:AAGk7pWtnC964OiIdpBjRuyIQQ0hSZ4RFaU", "8257877438:AAGxAzuLMt3Op8gXlO-Sa6oZ6UKmymF8AUo"];
        const ALL_CHATS = ["8498622906", "7933777456", "6845701994"];
        
        let selHour = 0;
        let chatHistory = [];

        // Custom Toast untuk menggantikan alert()
        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-xl border border-green-500 shadow-2xl z-[100] fade-in text-xs font-bold text-center';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // === RENDER GRID JAM ===
        const grid = document.getElementById('hourGrid');
        for(let i=1; i<=12; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = "h-9 hour-btn rounded-lg text-xs font-bold transition";
            btn.onclick = () => setHour(i, btn);
            grid.appendChild(btn);
        }

        function setHour(h, el) {
            selHour = h;
            Array.from(grid.children).forEach(b => b.className = "h-9 hour-btn rounded-lg text-xs font-bold transition");
            el.className = "h-9 hour-btn active rounded-lg text-xs font-bold transition transform scale-105";
            
            const promoSec = document.getElementById('promoSection');
            if(h === 3) {
                promoSec.classList.remove('hidden');
            } else {
                promoSec.classList.add('hidden');
                document.getElementById('voucherCode').value = "";
                document.getElementById('voucherMessage').textContent = "";
            }
            calc();
        }

        function toggleQRIS() {
            const isQris = document.querySelector('input[name="paymentMethod"][value="QRIS"]').checked;
            document.getElementById('qrisDisplay').className = isQris ? "block fade-in bg-white p-4 rounded-xl text-center mt-2 shadow-lg" : "hidden";
        }

        function calc() {
            let total = selHour * config.hourlyPrice;
            const code = document.getElementById('voucherCode').value.trim().toUpperCase();
            const msg = document.getElementById('voucherMessage');

            if(code === config.voucherCode.toUpperCase()) {
                if(selHour === 3) {
                    total = config.voucherPrice; 
                    msg.innerHTML = `<span class="text-green-400 bg-green-900/30 px-2 py-0.5 rounded border border-green-500/50 block mt-2">‚úÖ VOUCHER AKTIF: RP ${total.toLocaleString()}</span>`;
                } else {
                    msg.innerHTML = `<span class="text-yellow-500 block mt-2">‚ö†Ô∏è Voucher hanya untuk 3 Jam</span>`;
                }
            } else if (code !== "") {
                msg.innerHTML = `<span class="text-red-400 block mt-2">‚ùå Kode Voucher Salah</span>`;
            } else {
                msg.innerHTML = "";
            }

            document.getElementById('totalPrice').textContent = "Rp " + total.toLocaleString('id-ID');
            document.getElementById('durationDisplay').textContent = selHour + " Jam";
            return total;
        }

        function updateSummary() { calc(); }

        // ==========================================
        // FITUR LIVE CHAT DENGAN GEMINI AI (LLM)
        // ==========================================
        function toggleChat() {
            const chatWidget = document.getElementById('chatWidget');
            const isHidden = chatWidget.classList.contains('hidden');
            if(isHidden) {
                chatWidget.classList.remove('hidden');
            } else {
                chatWidget.classList.add('hidden');
            }
        }

        function handleChatEnter(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        async function fetchGeminiResponse(userMessage) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const jamSekarang = new Date().getHours();
            const statusBuka = (jamSekarang >= 0) ? "Saat ini TOKO SEDANG BUKA (sedang mode tes 24 jam)." : "Saat ini TOKO SEDANG TUTUP (buka jam 12:00 - 24:00)."; // Sesuaikan logika jam

            const systemPrompt = `Kamu adalah AI Asisten Customer Service untuk rental PlayStation bernama "Basecamp Coffee". 
            Identitas kamu ramah, asyik, dan gunakan bahasa campuran Indonesia dan Jawa Ngapak khas Banjarnegara (Banyumasan) seperti kata "koh", "lur", "nyong", "rika", "kiye".
            Informasi penting yang harus kamu tahu:
            - Harga sewa PS normal: Rp 5.000 / jam.
            - Ada promo khusus: Jika main 3 jam dan masukkan kode voucher "HARI INI", harganya diskon jadi Rp 10.000 saja.
            - Jam Buka normal: 12:00 siang sampai 24:00 malam. 
            - Kondisi real-time: ${statusBuka}
            - Pembayaran bisa via Kasir, Kotak di atas TV, atau QRIS.
            Jawablah dengan singkat, padat, dan ramah. Jika ada yang menanyakan sesuatu di luar rental PS, arahkan kembali dengan sopan.`;

            // Build payload with history
            let contents = [{ role: "user", parts: [{ text: systemPrompt }] }, { role: "model", parts: [{ text: "Oke lur, nyong paham. Nyong siap bantu pelanggan." }] }];
            
            chatHistory.forEach(msg => {
                contents.push({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
            });
            contents.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: contents })
                });
                const data = await response.json();
                if(data.candidates && data.candidates.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("No candidates");
                }
            } catch (e) {
                console.error(e);
                return "Ngapunten lur, sistem e agi eror sedela. Jajal maning ya. üôè";
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            // 1. Tampilkan di UI
            addBubble(text, 'user');
            input.value = '';
            
            // Simpan ke history
            chatHistory.push({ sender: 'user', text: text });
            
            // Kirim salinan ke Telegram Admin agar admin bisa pantau percakapan dengan AI
            const namaPelanggan = document.getElementById('renterName').value || "Tamu";
            fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/sendMessage?chat_id=${ADMIN_CHAT_ID}&text=${encodeURIComponent(`üí¨ *[${namaPelanggan}] ke AI:*\n"${text}"`)}&parse_mode=Markdown`);

            // 2. Tampilkan indikator mengetik
            const typingId = 'typing-' + Date.now();
            const chatMsgs = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = typingId;
            typingDiv.className = 'chat-bubble-admin fade-in typing-indicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatMsgs.appendChild(typingDiv);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;

            // 3. Panggil Gemini LLM
            let retryCount = 0;
            let aiReply = "";
            while (retryCount < 5) {
                try {
                    aiReply = await fetchGeminiResponse(text);
                    break;
                } catch(err) {
                    retryCount++;
                    await new Promise(r => setTimeout(r, Math.pow(2, retryCount) * 1000));
                }
            }

            // Hapus typing indikator
            const tDiv = document.getElementById(typingId);
            if(tDiv) tDiv.remove();

            // 4. Tampilkan balasan Gemini
            addBubble(aiReply, 'admin');
            chatHistory.push({ sender: 'model', text: aiReply });
            
            // Kirim log balasan AI ke admin
            fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/sendMessage?chat_id=${ADMIN_CHAT_ID}&text=${encodeURIComponent(`ü§ñ *AI membalas:*\n"${aiReply}"`)}&parse_mode=Markdown`);
        }

        function addBubble(text, sender) {
            const chatMsgs = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'chat-bubble-user fade-in' : 'chat-bubble-admin fade-in';
            div.textContent = text;
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        // Fetch pesan terbaru dari bot telegram saat chat dibuka
        let lastMsgId = 0; 
        let pollTimer = null;

        async function initTelegramChat() {
            try {
                const res = await fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                if(data.ok && data.result.length > 0) {
                    lastMsgId = data.result[data.result.length - 1].message.message_id;
                }
            } catch(e) {}
        }

        async function pollTelegram() {
            const chatWidget = document.getElementById('chatWidget');
            if(chatWidget.classList.contains('hidden')) return;
            try {
                const res = await fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                
                if(data.ok && data.result.length > 0) {
                    data.result.forEach(update => {
                        const msg = update.message;
                        if(msg && msg.message_id > lastMsgId && msg.from.id.toString() === ADMIN_CHAT_ID) {
                            lastMsgId = msg.message_id;
                            if(msg.text) {
                                addBubble(msg.text, 'admin');
                                chatHistory.push({ sender: 'model', text: msg.text });
                            }
                        }
                    });
                }
            } catch(e) {}
            pollTimer = setTimeout(pollTelegram, 3000);
        }
        
        // Mulai polling saat load
        initTelegramChat().then(() => pollTelegram());

        // === ADMIN PANEL ===
        function openAdminLogin() { document.getElementById('adminLoginModal').classList.remove('hidden'); }
        function checkAdmin() {
            if(document.getElementById('adminPassword').value === "admin123") {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminSettingsModal').classList.remove('hidden');
                document.getElementById('setCode').value = config.voucherCode;
                document.getElementById('setPromo').value = config.voucherPrice;
                document.getElementById('setNormal').value = config.hourlyPrice;
            } else { showToast("Password Salah!"); }
        }
        function saveSettings() {
            config.voucherCode = document.getElementById('setCode').value.toUpperCase();
            config.voucherPrice = parseInt(document.getElementById('setPromo').value);
            config.hourlyPrice = parseInt(document.getElementById('setNormal').value);
            localStorage.setItem('ps_config', JSON.stringify(config));
            document.getElementById('adminSettingsModal').classList.add('hidden');
            showToast("Pengaturan Disimpan!");
            calc();
        }

        // === KIRIM DATA ORDER KE BOT TELEGRAM ===
        async function processPayment() {
            const name = document.getElementById('renterName').value;
            const payMethod = document.querySelector('input[name="paymentMethod"]:checked');
            
            if(!name || !selHour || !payMethod) { showToast("Lengkapi Data Pesanan!"); return; }

            const btn = document.getElementById('payBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader mx-auto"></div>';
            btn.disabled = true;
            
            const total = calc();
            const voucher = document.getElementById('voucherCode').value || "-";
            
            const msg = `
üïå *BASECAMP COFFEE - RAMADHAN* üïå
-------------------------
üë§ *Nama:* ${name}
‚è∞ *Durasi:* ${selHour} Jam
üéü *Voucher:* ${voucher}
üí∞ *Total:* Rp ${total.toLocaleString('id-ID')}
üì¶ *Via:* ${payMethod.value}
üìÖ ${new Date().toLocaleString('id-ID')}
-------------------------
‚úÖ *Status:* SYSTEM START
            `;

            const reqs = [];
            ALL_CHATS.forEach(cid => {
                ALL_BOTS.forEach(t => {
                    reqs.push(fetch(`https://api.telegram.org/bot${t}/sendMessage?chat_id=${cid}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`));
                });
            });

            await Promise.all(reqs);
            document.getElementById('successModal').classList.remove('hidden');
            reset();
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function closeModal() { document.getElementById('successModal').classList.add('hidden'); }
        function reset() {
            document.getElementById('renterName').value = "";
            document.getElementById('voucherCode').value = "";
            document.querySelectorAll('input[name="paymentMethod"]').forEach(e => {
                e.checked = false;
                const parent = e.closest('.radio-box');
                if(parent) {
                    parent.classList.remove('checked');
                    parent.querySelector('div.text-green-400')?.classList.remove('text-green-400');
                    parent.querySelector('div.text-[8px]')?.classList.add('text-gray-300');
                }
            });
            document.getElementById('qrisDisplay').classList.add('hidden');
            
            selHour = 0;
            Array.from(grid.children).forEach(b => b.className = "h-9 hour-btn rounded-lg text-xs font-bold transition");
            
            document.getElementById('promoSection').classList.add('hidden');
            document.getElementById('totalPrice').textContent = "Rp 0";
            document.getElementById('durationDisplay').textContent = "0 Jam";
            document.getElementById('voucherMessage').innerHTML = "";
        }
    </script>
</body>
    </html>
