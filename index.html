<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basecamp Coffee - Ramadhan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #111827;
            background-image: 
                radial-gradient(at 0% 0%, rgba(22, 101, 52, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(180, 83, 9, 0.2) 0px, transparent 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .font-arab { font-family: 'Amiri', serif; }

        @keyframes neon-blink {
            0%, 100% { opacity: 1; text-shadow: 0 0 5px #fbbf24, 0 0 10px #d97706; transform: scale(1); }
            50% { opacity: 0.7; text-shadow: none; transform: scale(0.98); }
        }
        .blinking-text { animation: neon-blink 2s infinite ease-in-out; }

        .app-card {
            width: 100%;
            max-width: 380px;
            background-color: #1f2937;
            border: 1px solid #166534;
            border-radius: 24px;
            box-shadow: 0 0 50px rgba(22, 163, 74, 0.15);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
        }

        .header-section {
            background: linear-gradient(160deg, #022c22 0%, #064e3b 100%);
            position: relative;
            padding: 15px 20px 20px 20px; 
            text-align: center;
            border-bottom: 2px solid #ca8a04;
            overflow: hidden;
        }

        .header-ornament {
            position: absolute;
            top: -20px; left: -20px;
            width: 100px; height: 100px;
            background: radial-gradient(circle, rgba(251,191,36,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .content-area {
            padding: 15px 20px;
            padding-bottom: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .content-area::-webkit-scrollbar { width: 0; }

        .input-dark {
            background-color: #111827;
            border: 1px solid #374151;
            color: white;
            transition: all 0.3s;
        }
        .input-dark:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
            outline: none;
        }
        .input-dark:disabled {
            background-color: #1f2937;
            border-color: #374151;
            color: #6b7280;
            cursor: not-allowed;
        }

        .btn-green-glow {
            background: linear-gradient(to right, #16a34a, #15803d);
            border: 1px solid #22c55e;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
            transition: transform 0.2s;
        }
        .btn-green-glow:active { transform: scale(0.98); }

        .hour-btn {
            background: #374151;
            border: 1px solid #4b5563;
            color: #d1d5db;
        }
        .hour-btn.active {
            background: #22c55e;
            color: black;
            font-weight: bold;
            border-color: #86efac;
            box-shadow: 0 0 10px #22c55e;
        }
        .hour-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .radio-box {
            background: #111827;
            border: 1px solid #374151;
            transition: all 0.2s;
        }
        input:checked + .radio-box {
            background: rgba(34, 197, 94, 0.15);
            border-color: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }
        input:checked + .radio-box i,
        input:checked + .radio-box div {
            color: #4ade80 !important;
        }
        input:disabled + .radio-box {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CHAT SYSTEM CSS */
        .chat-bubble-user {
            background-color: #166534;
            color: white;
            border-radius: 12px 12px 0 12px;
            padding: 8px 12px;
            font-size: 11px;
            max-width: 80%;
            align-self: flex-end;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .chat-bubble-admin {
            background-color: #374151;
            color: white;
            border-radius: 12px 12px 12px 0;
            padding: 8px 12px;
            font-size: 11px;
            max-width: 80%;
            align-self: flex-start;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border-left: 2px solid #ca8a04;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        /* CSS UNTUK ANIMASI MENGETIK BOT */
        .typing-indicator span {
            display: inline-block;
            width: 5px;
            height: 5px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #chatMessages::-webkit-scrollbar { width: 4px; }
        #chatMessages::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        
        .bg-whatsapp { background-color: #25D366; }
        .hover-bg-whatsapp:hover { background-color: #1ebe57; }
        .bg-gray-disabled { background-color: #4b5563; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="app-card">
        
        <!-- HEADER -->
        <div class="header-section">
            <div class="header-ornament"></div>
            <div class="mb-1 text-yellow-400 opacity-90 animate-pulse">
                <i class="fa-solid fa-moon text-lg"></i>
            </div>
            
            <h1 class="text-2xl text-yellow-400 font-arab font-bold mb-1 -mt-1 blinking-text leading-none relative z-10">
                Ø±Ù…Ø¶Ø§Ù† Ù…Ø¨Ø§Ø±Ùƒ
            </h1>
            
            <div class="relative z-10 mb-3 mt-2">
                <div class="text-lg font-bold text-white tracking-[0.2em] uppercase drop-shadow-md">PLAYSTATION</div>
                <div class="text-[11px] text-yellow-300 font-medium mt-1 animate-bounce">
                    Yuk! Booking dulu lewat aplikasi ini! ðŸ‘‡
                </div>
            </div>

            <div class="relative z-10 bg-black/20 backdrop-blur-sm border border-white/10 rounded-lg p-1.5 mx-10">
                <h2 class="text-[10px] font-bold text-green-300 font-sans tracking-wide uppercase drop-shadow-md mb-0.5">
                    Basecamp Coffee
                </h2>
                <p class="text-[6px] text-gray-300 font-light italic leading-tight">
                    Mengucapkan Selamat Menunaikan<br>Ibadah Puasa 1447 H
                </p>
            </div>
        </div>

        <div class="content-area space-y-4">
            
            <!-- Nama -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Nama Pelanggan</label>
                <div class="relative mt-1">
                    <span class="absolute left-3 top-2.5 text-green-600"><i class="fa-solid fa-user"></i></span>
                    <input type="text" id="renterName" class="w-full input-dark rounded-xl py-2.5 pl-9 pr-4 text-sm" placeholder="Masukkan nama...">
                </div>
            </div>

            <!-- Durasi -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Pilih Durasi (Jam)</label>
                <div class="grid grid-cols-6 gap-2 mt-1" id="hourGrid"></div>
            </div>

            <!-- Voucher -->
            <div id="promoSection" class="hidden fade-in bg-green-900/20 p-3 rounded-xl border border-green-600/30 border-dashed">
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase block"><i class="fa-solid fa-ticket mr-1"></i> Kode Voucher</label>
                
                <!-- Teks Bantuan Tambahan Dipindah ke Atas Input & Diperbesar -->
                <p class="text-[11px] text-gray-300 ml-1 mb-2 italic">jika salah bisa chat whatsapp di samping ðŸ‘ˆ</p>
                
                <input type="text" id="voucherCode" placeholder="Masukkan Kode Promo" oninput="updateSummary()" 
                    class="w-full bg-black/40 border border-green-600/30 rounded-lg py-2 text-center text-sm font-bold text-yellow-400 uppercase tracking-widest focus:outline-none focus:border-green-500 placeholder-gray-600 transition-colors">
                
                <!-- Pesan Voucher -->
                <p id="voucherMessage" class="text-center text-[10px] mt-1 font-bold min-h-[16px] transition-all"></p>
            </div>

            <!-- Metode Pembayaran -->
            <div>
                <label class="text-[10px] text-green-400 font-bold ml-1 uppercase">Metode Pembayaran</label>
                <div class="grid grid-cols-3 gap-2 mt-1">
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="Kotak (Atas TV)" class="peer sr-only payment-radio" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-box-open text-yellow-500 text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Kotak<br>(Atas TV)</div>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="Kasir" class="peer sr-only payment-radio" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-cash-register text-blue-400 text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Bayar<br>di Kasir</div>
                        </div>
                    </label>
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="paymentMethod" value="QRIS" class="peer sr-only payment-radio" onchange="toggleQRIS()">
                        <div class="radio-box p-2 rounded-xl text-center h-full flex flex-col justify-center items-center">
                            <i class="fa-solid fa-qrcode text-white text-lg mb-1 transition-colors"></i>
                            <div class="text-[8px] text-gray-300 font-bold uppercase leading-tight mt-1 transition-colors">Scan<br>QRIS</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Tampilan QRIS -->
            <div id="qrisDisplay" class="hidden fade-in bg-white p-4 rounded-xl text-center shadow-lg mt-2">
                <p class="text-black font-bold text-xs mb-2">Scan QRIS</p>
                <img src="QRIS.jpg" onerror="this.src='https://via.placeholder.com/150?text=QRIS+ERROR'" class="mx-auto w-32 h-32 object-contain border border-black rounded">
            </div>

            <!-- Total -->
            <div class="bg-black/60 backdrop-blur-md rounded-xl p-4 border-l-4 border-green-500 flex justify-between items-center mt-2">
                <div>
                    <p class="text-[9px] text-gray-400 uppercase tracking-wide">Total Pembayaran</p>
                    <p class="text-white font-bold text-xl drop-shadow-sm" id="totalPrice">Rp 0</p>
                </div>
                <div class="text-right">
                    <span class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded font-bold uppercase" id="durationDisplay">0 Jam</span>
                </div>
            </div>

            <!-- Tombol Submit -->
            <button onclick="processPayment()" id="payBtn"
                class="w-full btn-green-glow py-4 rounded-xl text-white font-bold text-sm tracking-wider flex justify-center items-center gap-2 mt-2">
                <i class="fa-solid fa-play"></i> BOOKING SEKARANG
            </button>

            <!-- Footer -->
            <div class="text-center text-[8px] text-gray-600 pt-2 pb-4">
                &copy; 2026 Basecamp Coffee System (AI Supported)
            </div>

        </div>
    </div>

    <!-- TMBOL CHAT MENGAMBANG -->
    <button id="chatToggleBtn" onclick="toggleChat()" class="fixed bottom-6 left-6 text-white w-14 h-14 rounded-full shadow-lg z-40 flex items-center justify-center transition transform active:scale-95 group">
        <i class="fa-brands fa-whatsapp text-3xl"></i>
        <!-- Tooltip jika sedang tutup -->
        <span id="chatClosedTooltip" class="absolute left-16 bg-gray-900 text-white text-[10px] px-3 py-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition whitespace-nowrap hidden pointer-events-none">
            Chat Offline (Buka 05:00 - 24:00)
        </span>
    </button>

    <!-- KOTAK CHAT IN-APP -->
    <div id="chatWidget" class="hidden fixed bottom-24 left-6 w-72 sm:w-80 bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl z-50 flex flex-col overflow-hidden fade-in">
        <div class="bg-gradient-to-r from-green-700 to-green-900 p-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-black/30 rounded-full flex items-center justify-center border border-green-400">
                    <i class="fa-brands fa-whatsapp text-green-200 text-lg"></i>
                </div>
                <div>
                    <h3 class="text-white text-xs font-bold leading-tight">Live Chat Basecamp</h3>
                    <p id="chatStatus" class="text-[9px] text-green-200 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> Online
                    </p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-white/70 hover:text-white"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        
        <div id="chatMessages" class="p-3 h-64 bg-[#111827] flex flex-col gap-3 overflow-y-auto relative">
            <div class="text-center text-[9px] text-gray-500 my-2 shrink-0">Live Support</div>
            <div class="chat-bubble-admin fade-in shrink-0">
                Iki lurr voucher e jika booking di 3 jam<br>( <span id="teksWelcomeVoucher" class="font-bold text-yellow-300"></span> )
            </div>
        </div>
        
        <div class="p-2 bg-gray-800 border-t border-gray-700 flex gap-2 items-center">
            <input type="text" id="chatInput" onkeypress="handleChatEnter(event)" placeholder="Ketik pesene sampeyan..." class="flex-1 min-w-0 bg-gray-900 text-white text-xs rounded-xl py-2 px-3 border border-gray-600 focus:border-green-500 focus:outline-none">
            <button id="sendChatBtn" onclick="sendChatMessage()" class="shrink-0 w-9 h-9 flex items-center justify-center bg-whatsapp hover-bg-whatsapp text-white rounded-xl transition">
                <i class="fa-solid fa-paper-plane text-xs"></i>
            </button>
        </div>
    </div>

    <!-- MODAL SUCCESS -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-6">
        <div class="bg-slate-900 rounded-2xl p-8 max-w-xs w-full text-center border border-green-500 shadow-2xl relative overflow-hidden">
            <div class="w-16 h-16 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500 animate-pulse">
                <i class="fa-solid fa-check text-3xl text-green-400"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">BERHASIL!</h2>
            <p class="text-gray-400 text-xs mb-6">Orderan terkirim. Selamat bermain!</p>
            <button onclick="closeModal()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl transition">TUTUP</button>
        </div>
    </div>

    <script>
        // =====================================================================
        // âš™ï¸ PENGATURAN VOUCHER & HARGA (UBAH DI SINI SAJA YA LUR!) âš™ï¸
        // =====================================================================
        
        // 1. Ganti kata di dalam tanda kutip untuk ubah KODE VOUCHER & JAWABAN BOT
        const KODE_VOUCHER_HARI_INI = "promo123"; 
        
        // 2. Ganti angka ini untuk ubah HARGA PROMO (Tulis tanpa titik)
        const HARGA_PROMO_3_JAM = 13000; 

        // 3. Ganti angka ini untuk ubah HARGA NORMAL per 1 Jam (Tulis tanpa titik)
        const HARGA_NORMAL_PER_JAM = 5000;
        
        // =====================================================================
        // JANGAN UBAH KODE DI BAWAH GARIS INI KECUALI PAHAM JAVASCRIPT!
        // =====================================================================

        // Inject voucher ke pesan sambutan bot otomatis
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("teksWelcomeVoucher").textContent = KODE_VOUCHER_HARI_INI;
        });

        // === CEK JAM BUKA TOKO (KESELURUHAN) ===
        let isStoreOpen = false;

        function checkStoreHours() {
            const now = new Date();
            const hour = now.getHours(); // Format 24 jam (0 - 23)
            
            // Jam buka: 05:00 sampai 23:59
            if (hour >= 5 && hour <= 23) {
                isStoreOpen = true;
                
                // AKTIFKAN CHAT
                const toggleBtn = document.getElementById('chatToggleBtn');
                toggleBtn.classList.add('bg-whatsapp', 'hover-bg-whatsapp');
                toggleBtn.classList.remove('bg-gray-disabled');
                document.getElementById('chatClosedTooltip').classList.add('hidden');
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendChatBtn').disabled = false;
                document.getElementById('chatInput').placeholder = "Ketik pesene sampeyan...";
                document.getElementById('chatStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> Online';
                
                // AKTIFKAN FORM ORDER
                document.getElementById('renterName').disabled = false;
                document.getElementById('voucherCode').disabled = false;
                document.getElementById('voucherCode').placeholder = "Masukkan Kode Promo";
                document.querySelectorAll('.payment-radio').forEach(r => r.disabled = false);
                
                // Kembalikan visual grid jam
                Array.from(document.getElementById('hourGrid').children).forEach(b => {
                    b.classList.remove('disabled');
                });

                // Tombol Pay
                const payBtn = document.getElementById('payBtn');
                payBtn.disabled = false;
                payBtn.innerHTML = '<i class="fa-solid fa-play"></i> BOOKING SEKARANG';
                payBtn.className = "w-full btn-green-glow py-4 rounded-xl text-white font-bold text-sm tracking-wider flex justify-center items-center gap-2 mt-2";
                
            } else {
                isStoreOpen = false;
                
                // MATIKAN CHAT
                const toggleBtn = document.getElementById('chatToggleBtn');
                toggleBtn.classList.remove('bg-whatsapp', 'hover-bg-whatsapp');
                toggleBtn.classList.add('bg-gray-disabled');
                document.getElementById('chatClosedTooltip').classList.remove('hidden');
                document.getElementById('chatInput').disabled = true;
                document.getElementById('sendChatBtn').disabled = true;
                document.getElementById('chatInput').placeholder = "Chat sedang Offline...";
                document.getElementById('chatStatus').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline (Tutup)';
                document.getElementById('chatWidget').classList.add('hidden');

                // MATIKAN FORM ORDER
                document.getElementById('renterName').disabled = true;
                document.getElementById('voucherCode').disabled = true;
                document.getElementById('voucherCode').placeholder = "Toko Sedang Tutup";
                document.querySelectorAll('.payment-radio').forEach(r => r.disabled = true);
                
                // Redupkan visual grid jam
                Array.from(document.getElementById('hourGrid').children).forEach(b => {
                    b.classList.add('disabled');
                    b.classList.remove('active');
                });

                // Matikan Promo Section
                document.getElementById('promoSection').classList.add('hidden');
                document.getElementById('voucherMessage').textContent = "";
                selHour = 0;
                calc();

                // Tombol Pay Tutup
                const payBtn = document.getElementById('payBtn');
                payBtn.disabled = true;
                payBtn.innerHTML = '<i class="fa-solid fa-lock"></i> BASECAMP TUTUP (Buka 05:00)';
                payBtn.className = "w-full bg-gray-700 py-4 rounded-xl text-gray-400 font-bold text-sm tracking-wider flex justify-center items-center gap-2 mt-2 cursor-not-allowed border border-gray-600";
            }
        }

        // BOT UNTUK NOTIFIKASI ORDER & LOG CHAT
        const CHAT_BOT_TOKEN = "8514459117:AAH3kJ4MLDwnhykBMTSCLKatglFudZfm_dM"; 
        const ADMIN_CHAT_ID = "7933777456"; 
        const ALL_BOTS = ["8339576140:AAGk7pWtnC964OiIdpBjRuyIQQ0hSZ4RFaU", "8257877438:AAGxAzuLMt3Op8gXlO-Sa6oZ6UKmymF8AUo"];
        const ALL_CHATS = ["8498622906", "7933777456", "6845701994"];
        
        let selHour = 0;
        let chatHistory = [];

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-5 py-3 rounded-xl border border-green-500 shadow-2xl z-[100] fade-in text-xs font-bold text-center z-50';
            toast.innerText = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        const grid = document.getElementById('hourGrid');
        for(let i=1; i<=12; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = "h-9 hour-btn rounded-lg text-xs font-bold transition";
            btn.onclick = () => setHour(i, btn);
            grid.appendChild(btn);
        }

        // Cek jam buka saat halaman dimuat
        checkStoreHours();
        // Cek berkala tiap menit
        setInterval(checkStoreHours, 60000);

        function setHour(h, el) {
            if (!isStoreOpen) {
                showToast("Basecamp belum buka! Kami buka jam 05:00 - 24:00");
                return;
            }

            selHour = h;
            Array.from(grid.children).forEach(b => b.className = "h-9 hour-btn rounded-lg text-xs font-bold transition");
            el.className = "h-9 hour-btn active rounded-lg text-xs font-bold transition transform scale-105";
            
            const promoSec = document.getElementById('promoSection');
            if(h === 3) {
                promoSec.classList.remove('hidden');
                calc();
            } else { 
                promoSec.classList.add('hidden'); 
                document.getElementById('voucherCode').value = ""; 
                document.getElementById('voucherMessage').innerHTML = "";
                calc();
            }
        }

        function toggleQRIS() {
            const isQris = document.querySelector('input[name="paymentMethod"][value="QRIS"]')?.checked;
            document.getElementById('qrisDisplay').className = isQris ? "block fade-in bg-white p-4 rounded-xl text-center mt-2 shadow-lg" : "hidden";
        }

        // === PERBAIKAN VALIDASI VOUCHER OTOMATIS MENGHITUNG DISKON ===
        function calc() {
            let total = selHour * HARGA_NORMAL_PER_JAM;
            const codeInput = document.getElementById('voucherCode');
            const code = codeInput.value.trim().toUpperCase();
            const msg = document.getElementById('voucherMessage');

            msg.innerHTML = "";
            msg.className = "text-center text-[10px] mt-1 font-bold min-h-[16px] transition-all";

            if(selHour === 3 && code !== "") {
                if(code === KODE_VOUCHER_HARI_INI.toUpperCase()) {
                    total = HARGA_PROMO_3_JAM; 
                    
                    // Hitung otomatis selisih harga normal vs promo
                    let hargaNormal3Jam = 3 * HARGA_NORMAL_PER_JAM;
                    let jumlahDiskon = hargaNormal3Jam - HARGA_PROMO_3_JAM;
                    let teksDiskon = jumlahDiskon % 1000 === 0 ? (jumlahDiskon/1000) + " ribu" : "Rp " + jumlahDiskon.toLocaleString('id-ID');

                    msg.innerHTML = `<i class="fa-solid fa-circle-check"></i> Kamu dapat diskon ${teksDiskon}!`;
                    msg.classList.add("text-green-400");
                    msg.classList.remove("text-red-500");
                    codeInput.style.borderColor = "#4ade80"; 
                } else {
                    msg.innerHTML = `<i class="fa-solid fa-circle-xmark"></i> Kode Voucher Salah!`;
                    msg.classList.add("text-red-500");
                    msg.classList.remove("text-green-400");
                    codeInput.style.borderColor = "#ef4444"; 
                }
            } else {
                codeInput.style.borderColor = "rgba(22, 163, 74, 0.3)";
            }

            document.getElementById('totalPrice').textContent = "Rp " + total.toLocaleString('id-ID');
            document.getElementById('durationDisplay').textContent = selHour + " Jam";
            return total;
        }

        function updateSummary() { calc(); }

        // ==========================================
        // FITUR LIVE CHAT DENGAN SESSION ID & AI AUTO REPLY
        // ==========================================
        let lastMsgId = 0; 
        
        let mySessionId = localStorage.getItem('chatSessionId');
        if (!mySessionId) {
            mySessionId = "ID-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            localStorage.setItem('chatSessionId', mySessionId);
        }

        async function initTelegramChat() {
            if (!isStoreOpen) return; 
            
            try {
                const res = await fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                if (data.ok && data.result.length > 0) {
                    let maxId = 0;
                    data.result.forEach(u => {
                        if(u.message && u.message.message_id > maxId) maxId = u.message.message_id;
                    });
                    lastMsgId = maxId;
                }
            } catch (e) { console.log("Init fail"); }
            pollTelegram();
        }

        async function pollTelegram() {
            if (!isStoreOpen) return; 
            
            try {
                const res = await fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                
                if (data.ok && data.result.length > 0) {
                    data.result.forEach(update => {
                        const msg = update.message;
                        
                        if (msg && msg.from && msg.from.id.toString() === ADMIN_CHAT_ID && msg.message_id > lastMsgId) {
                            lastMsgId = msg.message_id;

                            if (msg.text && msg.reply_to_message && msg.reply_to_message.text) {
                                if (msg.reply_to_message.text.includes(mySessionId)) {
                                    addBubble(msg.text, 'admin');
                                    
                                    const chatWidget = document.getElementById('chatWidget');
                                    if(chatWidget.classList.contains('hidden')) {
                                        chatWidget.classList.remove('hidden');
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {}
            setTimeout(pollTelegram, 3000);
        }

        setTimeout(initTelegramChat, 1000);

        function toggleChat() {
            if (!isStoreOpen) {
                showToast("Chat Offline. Kami buka jam 05:00 - 24:00");
                return;
            }
            const chatWidget = document.getElementById('chatWidget');
            chatWidget.classList.toggle('hidden');
        }

        function handleChatEnter(e) {
            if(e.key === 'Enter') sendChatMessage();
        }

        // FUNGSI ANIMASI MENGETIK
        function showTypingIndicator() {
            const chatMsgs = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.id = 'typingBubble';
            div.className = 'chat-bubble-admin fade-in flex items-center justify-center gap-1 h-8 w-16';
            div.innerHTML = '<div class="typing-indicator flex items-center"><span></span><span></span><span></span></div>';
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingBubble = document.getElementById('typingBubble');
            if(typingBubble) {
                typingBubble.remove();
            }
        }

        async function sendChatMessage() {
            if (!isStoreOpen) return;
            
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if(!text) return;

            addBubble(text, 'user');
            input.value = '';
            
            const namaPelanggan = document.getElementById('renterName').value || "Tamu";
            const textToTelegram = `ðŸ’¬ *[${namaPelanggan}]*:\n"${text}"\n\n_Ref: ${mySessionId}_`;
            
            // 1. Kirim pesan user ke Telegram Admin
            fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/sendMessage?chat_id=${ADMIN_CHAT_ID}&text=${encodeURIComponent(textToTelegram)}&parse_mode=Markdown`);

            // 2. KUMPULAN KATA KUNCI UNTUK AI BOT
            let botReply = "";
            const txt = text.toLowerCase().trim();
            
            const kataKunciPS = [
                "zahmene", "bukak", "buka", "rep psan", "psan", "pesan", 
                "wengi", "arep ps", "rep ps", "rental", "dolan", "maen", "main", "ps"
            ];

            const kataKunciIya = [
                "iya", "y", "iy", "ndi", "iza", "hooh", "gelem", 
                "nggih", "ya", "iya kang", "nggih kang", "iya mas"
            ];

            if (txt === "kang" || txt === "p" || txt === "oi" || txt === "mas") {
                botReply = "dalem";
            } 
            else if (kataKunciPS.some(kata => txt.includes(kata))) {
                const now = new Date();
                const hour = now.getHours();

                if (hour >= 17 && hour <= 20) {
                    botReply = "Nyong orong bili egen ng masjid .kuncine jikot bae ng kidul takon mae kifa,kon jikot kunci kaya kuwe.";
                } else {
                    botReply = "buka kuncine jikot bae. Ng umah kidul Nk egen turu gugah\n\nKie rep nganggo voucher pora?";
                }
            } 
            else if (kataKunciIya.includes(txt)) {
                // MENGAMBIL KODE LANGSUNG DARI PENGATURAN PALING ATAS (BARIS 1)
                botReply = KODE_VOUCHER_HARI_INI;
            }

            // 3. Eksekusi balasan otomatis JIKA ADA
            if (botReply !== "") {
                setTimeout(() => {
                    showTypingIndicator();
                }, 500); 

                setTimeout(() => {
                    removeTypingIndicator();
                    addBubble(botReply, 'admin');
                    
                    const botLog = `ðŸ¤– *[Auto-Reply Bot ke ${namaPelanggan}]*:\n"${botReply}"`;
                    fetch(`https://api.telegram.org/bot${CHAT_BOT_TOKEN}/sendMessage?chat_id=${ADMIN_CHAT_ID}&text=${encodeURIComponent(botLog)}&parse_mode=Markdown`);
                }, 2500); 
            }
        }

        function addBubble(text, sender) {
            const chatMsgs = document.getElementById('chatMessages');
            const div = document.createElement('div');
            div.className = sender === 'user' ? 'chat-bubble-user fade-in shrink-0' : 'chat-bubble-admin fade-in shrink-0';
            div.innerHTML = text; 
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        async function processPayment() {
            if (!isStoreOpen) return;

            const name = document.getElementById('renterName').value;
            const payMethod = document.querySelector('input[name="paymentMethod"]:checked');
            if(!name || !selHour || !payMethod) { showToast("Lengkapi Data Pesanan!"); return; }

            const btn = document.getElementById('payBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader mx-auto"></div>';
            btn.disabled = true;
            
            const total = calc();
            const voucher = document.getElementById('voucherCode').value || "-";
            const msg = `ðŸ•Œ *ORDER MASUK*\nðŸ‘¤ Nama: ${name}\nâ° Durasi: ${selHour} Jam\nðŸ’° Total: Rp ${total.toLocaleString('id-ID')}\nðŸ“¦ Via: ${payMethod.value}`;

            const reqs = [];
            ALL_CHATS.forEach(cid => {
                ALL_BOTS.forEach(t => {
                    reqs.push(fetch(`https://api.telegram.org/bot${t}/sendMessage?chat_id=${cid}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`));
                });
            });

            await Promise.all(reqs);
            document.getElementById('successModal').classList.remove('hidden');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function closeModal() { document.getElementById('successModal').classList.add('hidden'); }
    </script>
</body>
</html>